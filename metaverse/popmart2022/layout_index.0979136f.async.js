(self.webpackChunkljzw_virtualland=self.webpackChunkljzw_virtualland||[]).push([[608],{4977:function(e,t,n){"use strict";n.r(t),n.d(t,{default:function(){return j}});var r=n(35290),o=n.n(r),a=n(411),i=n.n(a),c=n(46686),s=n.n(c),u=n(93236),l=n(59082),f=n(78349),d=n(68907),p=n(6759),h=n(40940),w=n.n(h),m=n(47216),g=n.n(m),v=(n(29132),n(3290)),E=n(96791),S=(n(47067),n(32446)),y=n(89835),I=n(93435),T=n(39974),k=n(7972),b=n(79664),_=n(62086),x=(location.href.indexOf("192.168"),!0),j=function(){var e=(0,l.useAccess)(),t=(0,l.useModel)("global"),n=t.shareType,r=(t.setLotteryVisible,t.isPortrait),a=t.setIsPortrait,c=t.isNetLoading,h=(0,l.useModel)("user"),m=h.uuid,j=h.updataUserInfo,O=h.updateBaseInfo,Z=((0,l.useModel)("map").updateMapInfo,(0,u.useState)(!1)),A=s()(Z,2),R=A[0],C=A[1],N=(0,u.useRef)(0),L=(0,l.useIntl)();(0,u.useEffect)((function(){G(),M()}),[]),(0,u.useEffect)((function(){I.Z.on(S.Z.LOGIN_GUESS,H),(0,f.tq)()&&(0,d.rM)(".page-root")}),[]),(0,u.useEffect)((function(){N.current=n}),[n]),(0,u.useEffect)((function(){return I.Z.on(S.Z.R2T_ROTATE_SCREEN,B),function(){I.Z.off(S.Z.R2T_ROTATE_SCREEN,B)}}),[]);var B=function(){a(!p.NO.islandscape)};(0,u.useEffect)((function(){(0,f.CL)()&&(w().get("".concat(p.qD,"&url=").concat(encodeURIComponent(window.location.href.split("#")[0])),(function(e){var t=e.data.content;window.wx.config({debug:!1,appId:t.appId,timestamp:t.timestamp,nonceStr:t.nonceStr,signature:t.signature,jsApiList:["onMenuShareAppMessage","onMenuShareTimeline","updateAppMessageShareData","updateTimelineShareData"],openTagList:["wx-open-launch-weapp"]}),window.wx.ready((function(){(0,d.vH)("",U)})),window.wx.error((function(e){}))})),document.addEventListener("WeixinOpenTagsError",(function(e){})))}),[]);var M=function(){var e=g().parse(window.location.search,{ignoreQueryPrefix:!0}).token,t=window.localStorage.getItem("LOGIN_TYPE");e&&"wechat"===t?(window.localStorage.setItem("token",e),window.localStorage.setItem("last_change_token","wechat"),window.localStorage.removeItem("LOGIN_TYPE"),D()):window.localStorage.getItem("token")?D():(window.localStorage.removeItem("LOGIN_TYPE"),P())},P=function(){var e=i()(o()().mark((function e(){var t,n;return o()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,(0,E.guessToLogin)({code:m});case 2:200===(null==(t=e.sent)?void 0:t.code)&&(n=t.data,window.localStorage.setItem("token",n.Token),window.localStorage.setItem("last_change_token","guessToLogin"),j(n.UserInfo),K());case 4:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}(),D=function(){var e=i()(o()().mark((function e(){var t;return o()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,v.Z.getUserDetail({},(function(e){200===e.code?K():1002===e.code&&(localStorage.getItem("token")&&localStorage.removeItem("token"),P())}));case 2:t=e.sent,j(t);case 4:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}(),H=function(){x||(localStorage.removeItem("token"),localStorage.removeItem("LOGIN_TYPE"),window.location.replace((0,d.ch)(window.location.href.split("#")[0],"token")))},K=function(){x=!1,C(!0)},U=function(){1===N.current?I.Z.emit(S.Z.FINISH_TASK,y.U.SHARE_LOOK):2===N.current&&I.Z.emit(S.Z.FINISH_TASK,y.U.SHARE_MARK)},G=function(){var e=i()(o()().mark((function e(){var t;return o()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,v.Z.toGetBaseInfo();case 2:200===(null==(t=e.sent)?void 0:t.code)&&(O(t.data),F());case 4:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}(),F=function(){T.Z.loadProtoAndConnect().then((function(e){e.connected&&(setInterval((function(){T.Z.send("Base.TosHeartbeat",{DateTime:Date.now()}),I.Z.emit(S.Z.SOCKET_HEARTBEAT)}),1e4),T.Z.on("Base.TocHeartbeat",(function(){})),Y())})).catch((function(e){}))},Y=function(){(0,d.Do)()||T.Z.send("Base.TosJoinScene",{SceneType:1,LocationInfo:{X:1,Z:1,TargetX:1,TargetZ:1,MoveSpeed:1,DeltaRotation:1,StartTime:1,PushTime:1}},(function(){}))};return(0,_.jsx)(k.ErrorBoundary,{onError:function(e,t){var n=localStorage.getItem("errorInfo");localStorage.setItem("errorInfo",e+"---"+n)},FallbackComponent:function(e){var t=e.error,n=e.resetErrorBoundary;return(0,_.jsxs)("div",{role:"alert",children:[(0,_.jsx)("p",{children:"Something went wrong:"}),(0,_.jsx)("pre",{children:t.message}),(0,_.jsx)("button",{onClick:n,children:"Try again"})]})},children:(0,_.jsxs)("div",{className:"".concat(r?"isPortrait":""," page-root w-full h-full"),id:"page-root",children:[(0,_.jsxs)("div",{className:"w-full h-full",id:"homepage",children:[R&&(0,_.jsx)(l.Access,{accessible:e.canSeeAdmin,fallback:(0,_.jsx)("div",{children:"403"}),children:(0,_.jsx)(l.Outlet,{})}),(0,_.jsx)("div",{id:"react-portal-modal-container"})]}),(0,_.jsx)("div",{id:"react-portal-toast-container"}),c&&(0,_.jsx)(b.Z,{wrapperClassName:"spin",spinning:c,tip:L.formatMessage({id:"netError.loading.text"})})]})})}},7972:function(e,t,n){!function(e,t){"use strict";function n(e){if(e&&e.__esModule)return e;var t=Object.create(null);return e&&Object.keys(e).forEach((function(n){if("default"!==n){var r=Object.getOwnPropertyDescriptor(e,n);Object.defineProperty(t,n,r.get?r:{enumerable:!0,get:function(){return e[n]}})}})),t.default=e,Object.freeze(t)}var r=n(t);function o(e,t){return o=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},o(e,t)}function a(e,t){e.prototype=Object.create(t.prototype),e.prototype.constructor=e,o(e,t)}var i=function(e,t){return void 0===e&&(e=[]),void 0===t&&(t=[]),e.length!==t.length||e.some((function(e,n){return!Object.is(e,t[n])}))},c={error:null},s=function(e){function t(){for(var t,n=arguments.length,r=new Array(n),o=0;o<n;o++)r[o]=arguments[o];return(t=e.call.apply(e,[this].concat(r))||this).state=c,t.resetErrorBoundary=function(){for(var e,n=arguments.length,r=new Array(n),o=0;o<n;o++)r[o]=arguments[o];null==t.props.onReset||(e=t.props).onReset.apply(e,r),t.reset()},t}a(t,e),t.getDerivedStateFromError=function(e){return{error:e}};var n=t.prototype;return n.reset=function(){this.setState(c)},n.componentDidCatch=function(e,t){var n,r;null==(n=(r=this.props).onError)||n.call(r,e,t)},n.componentDidUpdate=function(e,t){var n,r,o=this.state.error,a=this.props.resetKeys;null!==o&&null!==t.error&&i(e.resetKeys,a)&&(null==(n=(r=this.props).onResetKeysChange)||n.call(r,e.resetKeys,a),this.reset())},n.render=function(){var e=this.state.error,t=this.props,n=t.fallbackRender,o=t.FallbackComponent,a=t.fallback;if(null!==e){var i={error:e,resetErrorBoundary:this.resetErrorBoundary};if(r.isValidElement(a))return a;if("function"==typeof n)return n(i);if(o)return r.createElement(o,i);throw new Error("react-error-boundary requires either a fallback, fallbackRender, or FallbackComponent prop")}return this.props.children},t}(r.Component);function u(e,t){var n=function(n){return r.createElement(s,t,r.createElement(e,n))},o=e.displayName||e.name||"Unknown";return n.displayName="withErrorBoundary("+o+")",n}function l(e){var t=r.useState(null),n=t[0],o=t[1];if(null!=e)throw e;if(null!=n)throw n;return o}e.ErrorBoundary=s,e.useErrorHandler=l,e.withErrorBoundary=u,Object.defineProperty(e,"__esModule",{value:!0})}(t,n(93236))}}]);